const test = require('tap').test
const nock = require('nock')

const listSourcemaps = require('../').listSourcemaps

test('list source maps', (t) => {
  const expectedSourcemaps = {
    'sourcemaps': [{
      'id': 'edseac2aea-csd9ac-4263ds-90a9-e59eb3a043c8',
      'javascriptUrl': 'http://blainesch.com/synthetic-multiverse/bundle.min.js',
      'releaseName': 'multiverse',
      'releaseId': '☃',
      'buildCommit': null,
      'repoUrl': null,
      'createdAt': '2017-03-06T19:21:23.470Z'
    }]
  }

  nock('https://sourcemaps.service.newrelic.com:443', {})
    .get('/v2/applications/1441/sourcemaps')
    .reply(200, expectedSourcemaps)

  t.plan(1)
  listSourcemaps({
    applicationId: 1441,
    apiKey: 'api-key'
  }, (err, sourcemaps) => {
    if (err) {
      t.fail(err)
      t.end()
      return
    }
    t.deepEqual(sourcemaps, expectedSourcemaps)
  })
})

test('list source maps with error', (t) => {
  nock('https://sourcemaps.service.newrelic.com:443', {})
    .get('/v2/applications/1441/sourcemaps')
    .reply(404, 'Not Found')

  t.plan(1)
  listSourcemaps({
    applicationId: 1441,
    apiKey: 'api-key'
  }, (err, sourcemaps) => {
    t.equal(err.message, 'Not Found')
  })
})

test('list source maps with limit and offset', (t) => {
  const expectedSourcemaps = {
    'sourcemaps': [{
      'id': 'edseac2aea-csd9ac-4263ds-90a9-e59eb3a043c8',
      'javascriptUrl': 'http://blainesch.com/synthetic-multiverse/bundle.min.js',
      'releaseName': 'multiverse',
      'releaseId': '☃',
      'buildCommit': null,
      'repoUrl': null,
      'createdAt': '2017-03-06T19:21:23.470Z'
    }]
  }
  nock('https://sourcemaps.service.newrelic.com:443', {})
    .get('/v2/applications/1441/sourcemaps')
    .query({limit: '100', offset: '100'})
    .reply(200, expectedSourcemaps)

  t.plan(1)
  listSourcemaps({
    applicationId: 1441,
    apiKey: 'api-key',
    limit: 100,
    offset: 100
  }, (err, sourcemaps) => {
    if (err) {
      t.fail(err)
      t.end()
      return
    }
    t.deepEqual(sourcemaps, expectedSourcemaps)
  })
})
